{%- if settings.cart_drawer -%}
  {%- liquid
	assign free_shipping = settings.free_shipping_cart
	assign free_shipping_minimum = settings.free_shipping_minimum_cart | times: 100
	assign total = cart.total_price
-%}
  
  <div
    class="side-panel cart-drawer"
    id="Cart-Drawer"
    tabindex="-1">
    <div class="side-panel-inner">
      <div class="side-panel-header">
        <div>
          <h4 class="body-font">{{ 'general.cart_drawer.title' | t }}</h4>
          <side-panel-close class="side-panel-close">{%- render 'svg-icons' with 'close' -%}</side-panel-close>
        </div>
      </div>
      <div class="side-panel-content">
        {%- if cart != empty -%}
          <div class="product-cart-item--container">
            {%- if free_shipping and settings.free_shipping_minimum_cart != blank -%}
              <aside
                class="free-shipping"
                data-cart-total="{{ total }}"
                data-minimum="{{ free_shipping_minimum }}">
                <div class="free-shipping--text">
                  {%- if total < free_shipping_minimum -%}
                    {%- assign remaining_amount = total | minus: free_shipping_minimum | abs | money_without_trailing_zeros -%}
                    {{ 'general.cart_drawer.free_shipping.spend_more_for_free_shipping_html' | t: amount: remaining_amount }}
                  {%- else -%}
                    {{ 'general.cart_drawer.free_shipping.free_shipping_applied_at_checkout' | t }}
                  {%- endif -%}
                </div>
                <div class="free-shipping--bar">
                  <div class="free-shipping--percentage"></div>
                </div>
              </aside>
            {%- endif -%}
            {% for item in cart.items %}
              <div class="product-cart-item" id="CartDrawerItem-{{ item.index | plus: 1 }}">
                <div class="product-cart-item-image">
                  <a
                    href="{{ item.url }}">
                    {% if item.product.metafields.image.cart_image_url != blank %}
                      {%- render 'responsive-image', image: item.product.metafields.image.cart_image_url.value , sizes: '192x0' -%}
                    {% else %}
                      {%- render 'responsive-image', image: item.image, sizes: '192x0' -%}
                    {% endif %}
                    <div class="loading-overlay">
                      {% render 'svg-icons' with 'thb-loading' %}
                    </div>
                  </a>
                </div>
                
                <div class="product-cart-item-info">
                
                {% assign product_info = item.product.metafields.info %}        
                {% assign is_chocolate_bar = false %}
                {% if item.product.type and item.product.type == 'Chocolate Bar' %}
                  {% assign is_chocolate_bar = true %}
                {% endif %}
                {% if item.product and item.product.type != 'Chocolate Bar' %}        
                  <div class="card__type">{{ item.product.type }}
                    {% unless is_chocolate_bar %}
                      {% if product_info.percentage %}
                      - {{ product_info.percentage }}%
                      {% endif %}
                    {% endunless %}
                  </div>       
                {%- elsif product.metafields.info.product_type != blank -%}
                  <p class="card__type">{{ product.metafields.info.product_type }}</p> 
                {% endif %}      
 
                  <a
                    href="{{ item.url }}"
                    title="{{ item.product.title | escape }}"
                    class="cart-product-link">
                    {% if item.product.metafields.info.cart_title != blank %}
                      {{ item.product.metafields.info.cart_title | metafield_tag }}
                    {% else %}
                      {{ item.product.title }}
                    {% endif %}
                  </a>

                  {%- if item.product.metafields.info.tasting_notes != blank and item.product.type == 'Chocolate Bar' -%}
                    <div class="card__tasting-notes">{{ item.product.metafields.info.tasting_notes }}</div>
                  {%- endif -%}
                  
                  <span class="price">
                    {%- if item.original_line_price != item.final_line_price -%}
                      <del>
                        <span class="amount">{{ item.original_line_price | money }}</span>
                      </del>
                      <ins>
                        <span class="amount">{{ item.final_line_price | money }}</span>
                      </ins>
                    {%- else -%}
                      <ins>
                        <span class="amount">{{ item.original_line_price | money }}</span>
                      </ins>
                    {%- endif -%}
                    {%- if item.variant.available and item.unit_price_measurement -%}
                      <small class="unit-price">
                        {{ item.variant.unit_price | money }}
                        <span class="unit-price-separator">/</span>
                        {%- if item.variant.unit_price_measurement.reference_value != 1 -%}
                          {{- item.variant.unit_price_measurement.reference_value -}}
                        {%- endif -%}
                        {{ item.variant.unit_price_measurement.reference_unit }}
                      </small>
                    {%- endif -%}
                  </span>
              
                  {% if item.selling_plan_allocation %}
                    <div class="properties">
                      <span class="selling-plan">{{ item.selling_plan_allocation.selling_plan.name }}</span>
                    </div>
                  {% endif %}
              
                  <div class="product-cart-item-options" data-cart-item-property-list>
                    {%- assign itemProperties = 'template ' | split: ' ' -%}
                    {%- assign property_size = item.properties | size -%}
                    {% if property_size > 0 %}
                      {%- assign itemProperties = item.properties -%}
                    {% endif %}

                    {% if property_size > 0 %}
                      {% for p in itemProperties %}
                        {% assign first_character_in_key = p.first | truncate: 1, '' %}
                        {% unless p.last == blank or first_character_in_key == '_' %}
                          <div class="cart-drawer__item-property">
                            <strong>{{ p.first | capitalize }}: </strong>
                            <span>{{ p.last | capitalize }}</span>
                          </div>
                        {% endunless %}
                      {% endfor %}
                    {% endif %}
                  </div>

                  {% unless item.variant.title contains 'Default' %}
                    <div class="product-cart-item-options">
                      {% for option in item.product.options %}
                        <span>{{ option }}</span>: {{ item.variant.options[forloop.index0] }} {% if option == 'Size' and item.variant.metafields.custom.variant_subtitle != blank %}<span class="variant__info">({{ item.variant.metafields.custom.variant_subtitle }})</span>{% endif %} {% if forloop.last != true %},
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endunless %}
                  {%- if item.discounts != blank -%}
                    <ul class="discounts" role="list">
                      {%- for discount in item.discounts -%}
                        <li class="discounts__discount">
                          {%- render 'svg-icons' with 'discount' -%}
                          {{ discount.title }} (-{{ discount.amount | money }})
                        </li>
                      {%- endfor -%}
                    </ul>
                  {%- endif -%}
                  <quantity-selector class="quantity cart-update small-qty" data-id="{{ item.key | escape }}">
                    <button
                      class="minus"
                      type="button"
                      aria-label="{{ 'products.product.quantity.decrease' | t: product: item.product.title | escape }}">{% render 'svg-icons' with 'minus' %}</button>
                    <input
                      type="number"
                      name="updates[]"
                      id="updates_{{ item.key }}"
                      value="{{ item.quantity }}"
                      min="{{ item.variant.quantity_rule.min }}"
                      {% if product.selected_or_first_available_variant.quantity_rule.max != null %}
                      max="{{ item.variant.quantity_rule.max }}"
                      {% endif %}
                      step="{{ item.variant.quantity_rule.increment }}"
                      class="qty"
                      data-index="{{ item.index | plus: 1 }}"
                      aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}">
                    <button
                      class="plus"
                      type="button"
                      aria-label="{{ 'products.product.quantity.increase' | t: product: item.product.title | escape }}">{% render 'svg-icons' with 'plus' %}</button>
                  </quantity-selector>
                  <a
                    href="{{ routes.cart_change_url }}?line={{ forloop.index }}&amp;quantity=0"
                    class="remove"
                    data-index="{{ item.index | plus: 1 }}">Remove</a>
                </div>
                <div class="product-cart-item-price">
                  <span class="price">
                    {%- if item.original_line_price != item.final_line_price -%}
                      <del>
                        <span class="amount">
                          <div class="pn-total-line-item" data-id="{{ item.key }}">{{ item.original_line_price | money }}</div>
                        </span>
                      </del>
                      <ins>
                        <span class="amount">{{ item.final_line_price | money }}</span>
                      </ins>
                    {%- else -%}
                      <ins>
                        <span class="amount">
                          <div class="pn-total-line-item" data-id="{{ item.key }}">{{ item.original_line_price | money }}</div>
                        </span>
                      </ins>
                    {%- endif -%}
                    {%- if item.variant.available and item.unit_price_measurement -%}
                      <small class="unit-price">
                        {{ item.variant.unit_price | money }}
                        <span class="unit-price-separator">/</span>
                        {%- if item.variant.unit_price_measurement.reference_value != 1 -%}
                          {{- item.variant.unit_price_measurement.reference_value -}}
                        {%- endif -%}
                        {{ item.variant.unit_price_measurement.reference_unit }}
                      </small>
                    {%- endif -%}
                  </span>
                </div>
              </div>
            {% endfor %}
          </div>
        {%- else -%}
          <div class="cart-drawer__empty-cart">
            {% render 'svg-icons' with 'thb-empty-cart' %}
            <p>{{ 'general.cart_drawer.cart_empty' | t }}</p>
            <a class="button accent2" href="/pages/shop">
              <span>{{ 'general.cart_drawer.start_shopping' | t }}</span>
            </a>
          </div>
        {%- endif -%}
     
      </div>
      {%- if cart != empty -%}
        <div class="side-panel-footer">
          {%- if settings.cart_drawer_notes -%}
            <button
              type="button"
              class="order-note-toggle mini-cart__row"
              id="order-note-toggle"
              aria-controls="mini-cart-note">{{ 'general.cart_drawer.add_order_note' | t }}
              <span></span>
            </button>
            <div class="order-note-toggle__content">
              <label for="mini-cart__notes">{{ 'general.cart_drawer.add_order_note' | t }}</label>
              <textarea
                name="note"
                id="mini-cart__notes"
                rows="5">{{ cart.note }}</textarea>
              <button class="button full">
                <span>{{ 'general.cart_drawer.save' | t }}</span>
              </button>
              <div class="order-note-toggle__content-overlay"></div>
            </div>
          {%- endif -%}
          <div class="cart-drawer-footer">
            {%- if cart.cart_level_discount_applications.size > 0 -%}
              {%- for discount in cart.cart_level_discount_applications -%}
                <div class="mini-cart__row mini-cart__discount">
                  <div class="mini-cart__label">{{ discount.title }}</div>
                  <span>(-{{ discount.total_allocated_amount | money }})</span>
                </div>
              {%- endfor -%}
            {%- endif -%}

            <div class="cart-drawer-buttons">
              {%- if settings.policy_text != blank -%}
                <p class="cart-policy-text">
                  {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
                    {{ 'sections.cart.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}
                  {%- elsif cart.taxes_included -%}
                    {{ 'sections.cart.taxes_included_but_shipping_at_checkout' | t }}
                  {%- elsif shop.shipping_policy.body != blank -%}
                    {{ 'sections.cart.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url }}
                  {%- else -%}
                    {{ 'sections.cart.taxes_and_shipping_at_checkout' | t }}
                  {%- endif -%}
                </p>
              {%- endif -%}   

              {%- if settings.free_shipping_text != blank -%}
                <p class="cart-policy-text">
                  {{ settings.free_shipping_text }}
                </p>
              {%- endif -%}                 
              {% if settings.cart_terms_conditions_enable %}
                <div class="cart-drawer-terms">
                  <input
                    type="checkbox"
                    id="CartDrawerTerms"
                    required>
                  <label for="CartDrawerTerms">
                    {% if settings.cart_terms_conditions_page != blank %}
                      {{ 'sections.cart.terms_html' | t: url: settings.cart_terms_conditions_page.url }}
                    {% else %}
                      {{ 'sections.cart.terms' | t }}
                    {% endif %}
                  </label>
                </div>
              {% endif %}
              {%- if settings.button_type == 'cart_drawer_checkout_button' -%}
                <a
                  href="/checkout"
                  class="button full"
                  title="{{ 'general.cart_drawer.view_cart' | t | escape }}">
                  <span>{{ 'general.cart_drawer.checkout' | t }}
                    <b>•</b>
                    {% if settings.currency_code_enabled %}
                      {{ cart.total_price | money_with_currency }}
                    {% else %}
                      {{ cart.total_price | money }}{% endif %}
                  </span>
                </a>
              {%- endif -%}
              {%- if settings.button_type == 'cart_drawer_cart_button' -%}
                <a
                  href="{{ routes.cart_url }}"
                  class="button full cart-checkout-button"
                  title="{{ 'general.cart_drawer.view_cart' | t | escape }}">
                  <span>{{ 'general.cart_drawer.checkout' | t }}
                    <b>•</b>
                    {% if settings.currency_code_enabled %}
                      {{ cart.total_price | money_with_currency }}
                    {% else %}
                      {{ cart.total_price | money }}{% endif %}
                  </span>
                </a>
              {%- endif -%}
            </div>
          </div>
        </div>
      {%- endif -%}
    </div>
       {%- if settings.cart_recommendations -%}
          <div class="cart-drawer--recommendations--container product-recommendations--parent">
            <product-recommendations class="cart-drawer--recommendations" data-url="{{ routes.product_recommendations_url }}?section_id=cart-drawer&product_id={{ cart.items[0].product_id }}&limit=4">
              {% if recommendations.performed and recommendations.products_count > 0 %}
                <h6 class="cart-drawer--recommendations--heading">{{ 'general.cart_drawer.you_may_also_like' | t }}</h6>
                <div class="cart-drawer--recommendations--products">
                  {% for recommendation in recommendations.products %}
                    {% if recommendation.handle != 'international-shipping-fee' %}
                      {% render 'product-card-small' product_small: recommendation, quick_add: true, add_to_cart: true %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </product-recommendations>
          </div>
        {%- endif -%}
  </div>
{%- endif -%}